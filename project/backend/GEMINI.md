# Project: Family-tree Management

## General Instructions:

- When generating new TypeScript code, please follow the existing coding style.
- Ensure all new functions and classes have JSDoc comments.
- Prefer functional programming paradigms where appropriate.
- All code should be compatible with TypeScript 5.0 and Node.js 20+.
- This project is using ESLint, so all objects and variables are defined must be have a clean type, Limit the use of any or unknown data types.

## Coding Style:

- Use 2 spaces for indentation.
- Interface names should be prefixed with `I` (e.g., `IUserService`).
- Private class members should be prefixed with an underscore (`_`).
- Always use strict equality (`===` and `!==`).

## Regarding Dependencies:

- Avoid introducing new external dependencies unless absolutely necessary.
- If a new dependency is required, please state the reason and waiting for confirm.

## Project Goals:

- **Description:** Family Tree Management System is a web application that helps store, manage, and visualize family genealogies. The system allows registration, login, member information management, displays a tree-like family tree diagram, and supports saving photo albums with locations and managing family events on a calendar.
- **Current Status:** Builded and testing base-modules with E2E Testing: auth (tested), family (tested), family-members, group (tested), group-members (tested), relationships and invite (tested).

## Tech Stack:

- **Languages:** TypeScript.
- **Framework:** NestJS, Prisma.
- **Database:** PostgreSQL.
- **Package Manager:** pnpm.

## Main Directory Struture:

- `/src/common`: Contains all re-use logic, filters, defined type returning, guards,...
- `/src/modules`: Contains all services and controllers, this folder is the place where define api routes.
- `/src/schedule`: Contains the auto-task, using for database with triggers and auto-actions.
- `/prisma/schema` :Contains all models that using to define object in back-end and database.
- `/test`: Contains all file test E2E.

## üóÑÔ∏è Prisma & Database Best Practices

- **Self-Relations:** Use explicit names for self-referencing relations (e.g., `ParentToChildren`, `SpouseToSpouse`) to avoid ambiguity.
- **Recursive Queries:** Since Prisma doesn't support infinite recursion natively, for tree visualization, prefer fetching a flat list of members within a `familyId` and building the tree in the Service layer.
- **Transaction Safety:** Always use `$transaction` for operations that affect multiple tables (e.g., adding a member and simultaneously creating their relationship records).
- **Naming Convention:** Map database columns to snake_case using `@map` while keeping Prisma fields in camelCase to match TypeScript standards.
- **Schema Management:** We use a multi-file schema approach (if applicable) or a organized single schema. Keep `id`, `createdAt`, and `updatedAt` consistent across all models.

## Special Note for Gemini:

- When working with Prisma, always remember to run `npx prisma generate` after changing the schema.
- Avoid suggesting libraries that are too old or not supported to this project.

## üß¨ Domain Specifics (Family Tree)

- **Data Integrity:** When creating relationships, verify gender and age logic (e.g., parents must be older than children).
- **Tree Visualization:** Data returned for the tree diagram should be optimized for recursive rendering (flattened array or nested JSON).
- **Privacy:** Always check membership/group permissions before returning sensitive family data.

## üöÄ Performance & Prisma Optimization

- **No Select All:** Prohibit using `include` for everything. Always define a specific `select` object to retrieve only necessary fields, especially for tree rendering.
- **Filtering & Pagination:** Every "List" API must support pagination (skip/take) and basic filtering via Prisma.
- **Validation before Write:** Use Prisma `$exists` patterns or manual checks to ensure no duplicate relationships are created (e.g., a person cannot have two biological fathers).

## üõ† Advanced TypeScript with Prisma

- **Return Types:** Use `Prisma.PromiseReturnType<typeof function>` for complex service returns to ensure the Controller has full type-safety.
- **Enums:** Always use the Enums generated by Prisma (e.g., `Gender`, `RelationshipType`) instead of hardcoded strings.

## Testing & Quality Assurance:

- **File pattern:**: When creating new file, the extension must be '.e2e-spec.ts'
- **Atomic Test Cases**: Each IT block must be a complete and independent process.
  - **Self-Contained Data**: Each test case must generate its own dataset. For APIs requiring authentication, the process in IT must include: Register (or create user) -> Login -> Obtain Token -> Execute the API to be tested.
  - **No Shared State**: Absolutely do not use Tokens or ID data from previous IT blocks. This ensures that if one test case fails, it does not cause other test cases to fail as well.
- **RBAC Integrity & State Change**:
  - When changing roles (e.g., Leader -> Non-leader), re-authentication of authority must be done immediately.
  - Do not use user information/tokens after demotion to access APIs requiring higher privileges, unless the test case is verifying the correctness of the blocking action (Expect 403).
- **E2E Workflow:**
  - Use Supertest to simulate requests.
  - Always test both sides: Success (200/201) and Failure (400/401/403/404) to ensure coverage.
- **Cleanup**: After each it or describe, test data must be cleaned up to avoid cluttering the test database.
